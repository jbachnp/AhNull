<!DOCTYPE html>

<!--
https://jbachnp.github.io/AhNull/cutearrow.html
https://jbachnp.github.io/AhNull/cutearrow.html?g=%0E%1F%22%06.%3F%7B%03y%5EyEyw%08W'%3F*%05~vzYu%5B%7D%05%22%0A%03%12.%06kB~%5Eu%00%7DZ%1C%0F2%01.%05%7D%5Czyig%04T%3DV.!**%5Ecy%5DO%5BnY%3A%0F'%02%2F%01%5CEVYPSR%5E%03%2F%03%02%2F%2FxX~gq%04%7DX2%0F%24()%01%7C%5Cy%02qX%7D%01%25%0C%0F%1C-%06k%07y%5DO%5BnY%08%0F'%02*%1B%7F_%7DCuvu%07%25%0F%22R
https://jbachnp.github.io/AhNull/cutearrow.html?m=%0E%1F%22%06.%3F%7B%03y%5EyEyw%08W'%3F*%05~vzYu%5B%7D%05%22%0A%03%12.%06kB~%5Eu%00%7DZ%1C%0F2%01.%05%7D%5Czyig%04T%3DV.!**%5Ecy%5DO%5BnY%3A%0F'%02%2F%01%5CEVYPSR%5E%03%2F%03%02%2F%2FxX~gq%04%7DX2%0F%24()%01%7C%5Cy%02qX%7D%01%25%0C%0F%1C-%06k%07y%5DO%5BnY%08%0F'%02*%1B%7F_%7DCuvu%07%25%0F%22R
file:///C:/Players/jbach/temp/kfc/cutearrow.html?m=%0E%1F%22%06.%3F%7B%03y%5EyEyw%08W'%3F*%05~vzYu%5B%7D%05%22%0A%03%12.%06kB~%5Eu%00%7DZ%1C%0F2%01.%05%7D%5Czyig%04T%3DV.!**%5Ecy%5DO%5BnY%3A%0F'%02%2F%01%5CEVYPSR%5E%03%2F%03%02%2F%2FxX~gq%04%7DX2%0F%24()%01%7C%5Cy%02qX%7D%01%25%0C%0F%1C-%06k%07y%5DO%5BnY%08%0F'%02*%1B%7F_%7DCuvu%07%25%0F%22R
file:///C:/Players/jbach/temp/kfc/cutearrow.html?g=%0E%1F%22%06.%3F%7B%03y%5EyEyw%08W'%3F*%05~vzYu%5B%7D%05%22%0A%03%12.%06kB~%5Eu%00%7DZ%1C%0F2%01.%05%7D%5Czyig%04T%3DV.!**%5Ecy%5DO%5BnY%3A%0F'%02%2F%01%5CEVYPSR%5E%03%2F%03%02%2F%2FxX~gq%04%7DX2%0F%24()%01%7C%5Cy%02qX%7D%01%25%0C%0F%1C-%06k%07y%5DO%5BnY%08%0F'%02*%1B%7F_%7DCuvu%07%25%0F%22R

-->


<html lang="en">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HK QR</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
	<link rel="icon" href="favicon.ico">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

	<!-- ✅ custom style -->
    <style>
    </style>
</head>
<body class="d-flex flex-column h-100" style="padding-top: 3rem">
	<!-- ✅ main ui/header -->
	<header>
		<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark py-0">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">KFHKC</a>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="header div[name='mainMenu']"><span class="navbar-toggler-icon"></span></button>
				
				<div class="collapse navbar-collapse" name="mainMenu">
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li name="mnu_1" class="nav-item"><a class="nav-link active" href="#" data-bs-toggle="modal" data-bs-target="#dlgFunc1">Set Magic Code</a></li>
					</ul>
				</div>
	
			</div>
		</nav>
	</header>

	<!-- ✅ main ui/user area -->
	<main class="container">
        <h1>Member Information</h1>
        <div id="divQR"></div>
    </main>    

	<!-- ✅ main ui/footer -->
	<footer class="footer fixed-bottom mt-auto py-1 bg-light">
		<div class="container">
            <h6>{App Foot}</h6>
		</div>
	</footer>

	<!-- ✅ dialogue/ -->
	<div class="modal fade" id="dlgFunc1" data-bs-backdrop="static" data-bs-keyboard="false">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header py-1">
					<h5 class="modal-title">Set Magic Code</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<input type="text" class="form-control" name="txtMagicCode" placeholder="Enter Magic Code" value="" required/>
					<div class="form-text">Please enter the magic code.</div>
				</div>
				<div class="modal-footer py-1">
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" name="btnDoSomething">Save</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ✅ custom script -->
    <script>
	    window.addEventListener("load",(async function(){
            document.querySelector("#dlgFunc1 *[name='btnDoSomething']").addEventListener('click', async (e)=>{
				let magicCode = document.querySelector("#dlgFunc1 *[name='txtMagicCode']").value;
                setCookie("magicCode", magicCode, 30);	//30 days
				location.reload();
            });
			document.querySelector("#dlgFunc1 *[name='txtMagicCode']").value = getCookie("magicCode");
			
            const params = new URLSearchParams(window.location.search);

			if(null !== params.get('g')){
				let mValue = window.document.URL.replace('/cutearrow.html?g=','/cutearrow.html?m=');

				const qrCode = new QRCodeStyling({
					width: 300,
					height: 300,
					type: "svg",
					data: mValue,	//*************
					image: "https://jbachnp.github.io/AhNull/hkhklogo.png",
					dotsOptions: {
						color: "#4267b2",
						type: "rounded"
					},
					backgroundOptions: {
						color: "#e9ebee",
					},
					imageOptions: {
						crossOrigin: "anonymous",
						margin: 4
					}
				});

				qrCode.append(document.getElementById("divQR"));            

			}

			if(null !== params.get('m')){
				document.getElementById("divQR").appendChild($(`<span>[1]</span>`)[0]);

				let magicCode = document.querySelector("#dlgFunc1 *[name='txtMagicCode']").value;

				try {

					document.getElementById("divQR").appendChild($(`<span>[1]</span>`)[0]);


					const r2 = params.get('m');
					document.getElementById("divQR").appendChild($(`<span>r2: ${r2}</span>`)[0]);

					//var r1 = decrypt(r2, "kfhkcl25048243");
					var r1 = decrypt(r2, magicCode);
					document.getElementById("divQR").appendChild($(`<span>r1: ${r1}</span>`)[0]);

					var r0 = b64DecodeUnicode(r1);
					document.getElementById("divQR").appendChild($(`<span>r0: ${r0}</span>`)[0]);
					
					let oMember = JSON.parse(r0);
					var z = oMember.f2;
					z = z.slice(0, 1) + "~~~" + z.slice(4);
					var dateSpan = document.createElement('h3');
					dateSpan.innerHTML = `${oMember.f3} ${oMember.f4}<br/>HKID: ${z}<br/>Card No: ${oMember.f7}`;
					document.getElementById("divQR").appendChild(dateSpan);
				} catch (e) {
					document.getElementById("divQR").appendChild($(`<span>e: ${e.toString()}</span>`)[0]);

					alert("Please re-enter the magic code.");
				}

				console.log(r0);
			}

			$("#divQR").append('<span>..</span>');

        })());
		
		function b64EncodeUnicode(str) {
		  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
			function(match, p1) {
			  return String.fromCharCode('0x' + p1);
			}));
		}

		function b64DecodeUnicode(base64) {
		  return decodeURIComponent(atob(base64).split('').map(function(c) {
			return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
		  }).join(''));
		}



		function encrypt(text, password) {
			let result = '';
			for (let i = 0; i < text.length; i++) {
				result += String.fromCharCode(text.charCodeAt(i) ^ password.charCodeAt(i % password.length));
			}
			return result;
		}

		function decrypt(text, password) {
			return encrypt(text, password); // XOR encryption and decryption are symmetric
		}
				
		function setCookie(cname, cvalue, exdays) {
			const d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			let expires = "expires=" + d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
		}
		
		function getCookie(cname) {
			let name = cname + "=";
			let decodedCookie = decodeURIComponent(document.cookie);
			let ca = decodedCookie.split(';');
			for(let i = 0; i < ca.length; i++) {
				let c = ca[i].trim();
				if (c.indexOf(name) == 0) {
					return c.substring(name.length, c.length);
				}
			}
			return "";
		}
		
    </script>
</body>
</html>
