<!DOCTYPE html> 
<html lang="en">
  <head>
    <title>Autisticä»”</title>
    <link rel="icon" href="img/snake-96.png">
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body>

    <!--UI-->
    <div id="joinView" class="bg-gray-100 w-96 items-center mx-auto flex flex-col mt-10 rounded-md p-4 space-y-4">
      <h1 class="text-center font-bold">Join Chat</h1>
      <div class="flex space-x-1">
        <input id="usernameInput" type="text" class="bg-white border border-gray-200 rounded-md px-2" placeholder="Enter your name" />
        <button id="joinButton" class="bg-indigo-600 px-2 py-1 text-sm text-white rounded-md" > Join </button>
      </div>
    </div>

    <div id="chatsView" class="w-64 h-96 mx-auto flex flex-col mt-10 hidden">
      <div class="messages flex-1 bg-gray-100">
        <ul id="messageList">
          <li>
            <div class="flex space-x-2 pl-2 pt-2">
              <div class="flex flex-col">
                <div class="flex items-baseline space-x-2">
                  <div class="text-sm font-bold">Tommy Lee</div>
                  <div class="text-sm text-gray-400">5:20 pm</div>
                </div>
                <div class="text-sm text-gray-500">Hello world</div>
              </div>
            </div>
          </li>
        </ul>
      </div>
      <div class="input h-11 w-full flex border border-slate-200 rounded-md">
        <input id="messageInput" type="text" class="outline-none flex-1 px-1" />
        <div class="p-1">
          <button id="sendButton" class="bg-indigo-600 p-2 rounded-lg">âž¤ </button>
        </div>
      </div>
    </div>

    <!--app logic 0-->
    <script type="module">
      console.log("loading module");

      //---------------------------------------------------
      //ðŸŸ¨ Firebase specifics

      // import { initializeApp } from "/__/firebase/9.17.1/firebase-app.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      const firebaseConfig = {
          apiKey: "AIzaSyBsxyR7KxF3BxwG9kCg3epvb2v3Is4odFc",
          authDomain: "etude23a.firebaseapp.com",
          projectId: "etude23a",
          storageBucket: "etude23a.appspot.com",
          messagingSenderId: "265280086896",
          appId: "1:265280086896:web:23411bad397a9ce7bd65b5"

          //   projectId: "fir-chat-a082b",
          //   databaseURL: "https://fir-chat-a082b-default-rtdb.firebaseio.com",
      };
      export const app = initializeApp(firebaseConfig);

      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      const auth = getAuth(app);

      import {
        getFirestore,
        addDoc,
        collection,
        onSnapshot,
        //doc,
        getDocs,
        query, where, orderBy, limit,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      const db = getFirestore(app);

      //---------------------------------------------------
      //---------------------------------------------------

      // const docRef = await _MyFirebase._firestore.addDoc(_MyFirebase._firestore.collection(_MyFirebase.db, "messages"), {



      window._MyFirebase = {
        _auth: {
        },
        _firestore: {
          //getFirestore: getFirestore,
          addDoc: addDoc,
          collection: collection,
          onSnapshot: onSnapshot,
          //doc: doc,
          getDocs: getDocs,

          query: query,
          where: where,
          orderBy: orderBy,
          limit: limit,

        },


        db: ((rootObj)=>{
          const _collection = (path)=>collection(rootObj, path);
          const _addDoc = async (collectionRef, data) => await addDoc(collectionRef, data);
          const _getDocs = async (collectionRef) => getDocs(collectionRef);

          const addCollectionDoc = async (path, data) => await _addDoc(_collection(path), data);
          const getCollectionDocs = async (path) => _getDocs(_collection(path));
          const queryCollection = (path)=> query(_collection(path));
 
          return {
            db: rootObj,
            collection: _collection,
            addDoc: _addDoc,
            getDocs: _getDocs,

            addCollectionDoc: addCollectionDoc,
            getCollectionDocs: getCollectionDocs,
            queryCollection: queryCollection,
          }
        })(db),
        
        auth: ((rootObj)=>{
          return {
            auth: rootObj,
            signInAnonymously: async ()=>signInAnonymously(rootObj),
          }
        })(auth)
      };

    </script>

    <!--app logic-->
    <script type="module">
      console.log("loading old script");

      console.log(window._MyFirebase);

      //---------------------------------------------------
      const joinView = document.getElementById("joinView");
      const joinButton = document.getElementById("joinButton");
      const usernameInput = document.getElementById("usernameInput");

      const chatsView = document.getElementById("chatsView");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");

      let userLoggedIn = false;
      let specifiedUsername = "";
      let messages = [];

      joinButton.addEventListener("click", () => {
        specifiedUsername = usernameInput.value;

        if (!specifiedUsername) {
          alert("username cannot be empty");
          return;
        }

        _MyFirebase.auth.signInAnonymously()
        .then(async () => {
          console.log("User logged-in");
          userLoggedIn = true;

          joinView.classList.add("hidden");
          chatsView.classList.remove("hidden");

          await loadHistoricalMessages();
          await subscribeToNewMessages();
          writeMessagesArray();
        })
        .catch((error) => {
          console.log(error.code, error.message);
        });
      });
        
      sendButton.addEventListener("click", async () => {
        const message = messageInput.value;
        messageInput.value = "";
      
        const docRef = await _MyFirebase.db.addCollectionDoc("messages", {
          user: specifiedUsername,
          message: message,
          created: new Date(),
        });
        console.log(docRef);
      });
        
      async function loadHistoricalMessages() {
        messages = [];
        
        // const querySnapshot = await _MyFirebase.db.getCollectionDocs("messages");

        const _FS = _MyFirebase._firestore;
        const q = _FS.query(_MyFirebase.db.collection("messages"), _FS.where("user", "==", specifiedUsername));
        const querySnapshot = await _FS.getDocs(q);

        querySnapshot.forEach((doc) => {
          messages.push({
            id: doc.id,
            ...doc.data(),
          });
        });
        
        return messages;
      }
        
      function subscribeToNewMessages() {
        // const q = _MyFirebase.db.queryCollection("messages");

        const _FS = _MyFirebase._firestore;
        const q = _FS.query(_MyFirebase.db.collection("messages"), _FS.where("user", "==", specifiedUsername));

        const unsubscribe = _MyFirebase._firestore.onSnapshot(q, (querySnapshot) => {
          const newMessages = [];
          querySnapshot.forEach((doc) => {
            newMessages.push({
              id: doc.id,
              ...doc.data(),
            });
          });
      
          // Creating hash map of the existing messages.
          let existingMessageHash = {};
          for (let message of messages) {
            existingMessageHash[message.id] = true;
          }
      
          // Push only those messages which do not exis
          for (let message of newMessages) {
            if (!existingMessageHash[message.id]) {
              messages.push(message);
            }
          }
      
          writeMessagesArray();
        });
      }
      
      function writeMessagesArray() {
        const html = [];
        messages.sort((p, q)=>p.created > q.created ? 1 : -1);
        for (let message of messages) {
          html.push(messageTemplate(message.message, message.user, message.created));
        }
        document.getElementById("messageList").innerHTML = html.join("");
      }
        
      function messageTemplate(message, username, timestamp) {
        return `<li>
          <div class="flex space-x-2 pl-2 pt-2">
            <div class="flex flex-col">
              <div class="flex items-baseline space-x-2">
                <div class="text-sm font-bold">${username}</div>
                <div class="text-sm text-gray-400">${
                  new Date(timestamp.seconds * 1000).toLocaleDateString() +
                  " " +
                  new Date(timestamp.seconds * 1000).toLocaleTimeString()
                }</div>
              </div>
              <div class="text-sm text-gray-500">${message}</div>
            </div>
          </div>
        </li>`;
      }
    
    </script>
          
  </body>
</html>
