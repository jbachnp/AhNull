<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Autisticä»”</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body>

    <!--UI-->
    <div id="joinView" class="bg-gray-100 w-96 items-center mx-auto flex flex-col mt-10 rounded-md p-4 space-y-4">
    <h1 class="text-center font-bold">Join Chat</h1>
    <div class="flex space-x-1">
    <input
    id="usernameInput"
    type="text"
    class="bg-white border border-gray-200 rounded-md px-2"
    placeholder="Enter your name"
    />
    <button
    id="joinButton"
    class="bg-indigo-600 px-2 py-1 text-sm text-white rounded-md"
    >
    Join
    </button>
    </div>
    </div>

    <div id="chatsView" class="w-64 h-96 mx-auto flex flex-col mt-10 hidden">
    <div class="messages flex-1 bg-gray-100">
    <ul id="messageList">
    <li>
    <div class="flex space-x-2 pl-2 pt-2">
    <div class="flex flex-col">
    <div class="flex items-baseline space-x-2">
    <div class="text-sm font-bold">Tommy Lee</div>
    <div class="text-sm text-gray-400">5:20 pm</div>
    </div>
    <div class="text-sm text-gray-500">Hello world</div>
    </div>
    </div>
    </li>

    <li>
    <div class="flex space-x-2 pl-2 pt-2">
    <div class="flex flex-col">
    <div class="flex items-baseline space-x-2">
    <div class="text-sm font-bold">Tommy Lee</div>
    <div class="text-sm text-gray-400">5:21 pm</div>
    </div>
    <div class="text-sm text-gray-500">Testing</div>
    </div>
    </div>
    </li>

    <li>
    <div class="flex space-x-2 pl-2 pt-2">
    <div class="flex flex-col">
    <div class="flex items-baseline space-x-2">
    <div class="text-sm font-bold">James Bond</div>
    <div class="text-sm text-gray-400">5:21 pm</div>
    </div>
    <div class="text-sm text-gray-500">Good Job</div>
    </div>
    </div>
    </li>
    </ul>
    </div>
    <div class="input h-11 w-full flex border border-slate-200 rounded-md">
    <input id="messageInput" type="text" class="outline-none flex-1 px-1" />
    <div class="p-1">
    <button id="sendButton" class="bg-indigo-600 p-2 rounded-lg">
    <svg
    xmlns="http://www.w3.org/2000/svg"
    fill="white"
    viewBox="0 0 24 24"
    stroke-width="1.5"
    stroke="black"
    class="w-4 h-4"
    >
    <path
    stroke-linecap="round"
    stroke-linejoin="round"
    d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
    />
    </svg>
    </button>
    </div>
    </div>
    </div>


    <!--app logic 0-->
    <script type="module">
      console.log("loading module");

      //---------------------------------------------------
      //ðŸŸ¨ Firebase specifics

      // import { initializeApp } from "/__/firebase/9.17.1/firebase-app.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      const firebaseConfig = {
          apiKey: "AIzaSyBsxyR7KxF3BxwG9kCg3epvb2v3Is4odFc",
          authDomain: "etude23a.firebaseapp.com",
          projectId: "etude23a",
          storageBucket: "etude23a.appspot.com",
          messagingSenderId: "265280086896",
          appId: "1:265280086896:web:23411bad397a9ce7bd65b5"

          //   projectId: "fir-chat-a082b",
          //   databaseURL: "https://fir-chat-a082b-default-rtdb.firebaseio.com",
      };
      export const app = initializeApp(firebaseConfig);

      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      const auth = getAuth(app);

      import {
        getFirestore,
        addDoc,
        collection,
        onSnapshot,
        //doc,
        getDocs,
        query,
        //where,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      const db = getFirestore(app);

      window._MyFirebase = {
        _auth: {
        },
        _firestore: {
          //getFirestore: getFirestore,
          addDoc: addDoc,
          collection: collection,
          onSnapshot: onSnapshot,
          //doc: doc,
          getDocs: getDocs,
          query: query,
          //where: where,
        },

        db: db,
        signInAnonymously: async ()=>signInAnonymously(auth)
      };


      
    </script>

    <!--app logic-->
    <script type="module">
      console.log("loading old script");

      console.log(window._MyFirebase);

      //---------------------------------------------------
      const joinView = document.getElementById("joinView");
      const joinButton = document.getElementById("joinButton");
      const usernameInput = document.getElementById("usernameInput");

      const chatsView = document.getElementById("chatsView");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");

      let userLoggedIn = false;
      let specifiedUsername = "";
      let messages = [];

      joinButton.addEventListener("click", () => {
        specifiedUsername = usernameInput.value;

        if (!specifiedUsername) {
          alert("username cannot be empty");
          return;
        }

        _MyFirebase.signInAnonymously()
        .then(async () => {
          console.log("User logged-in");
          userLoggedIn = true;

          joinView.classList.add("hidden");
          chatsView.classList.remove("hidden");

          await loadHistoricalMessages();
          await subscribeToNewMessages();
          writeMessagesArray();
        })
        .catch((error) => {
          console.log(error.code, error.message);
        });
      });
        
        sendButton.addEventListener("click", async () => {
          const message = messageInput.value;
          messageInput.value = "";
        
          const docRef = await _MyFirebase._firestore.addDoc(_MyFirebase._firestore.collection(_MyFirebase.db, "messages"), {
            user: specifiedUsername,
            message: message,
            created: new Date(),
          });
          console.log(docRef);
        });
        
        function subscribeToNewMessages() {
          const q = _MyFirebase._firestore.query(_MyFirebase._firestore.collection(_MyFirebase.db, "messages"));
          const unsubscribe = _MyFirebase._firestore.onSnapshot(q, (querySnapshot) => {
            const newMessages = [];
            querySnapshot.forEach((doc) => {
              newMessages.push({
                id: doc.id,
                ...doc.data(),
              });
            });
        
            /**
             * Creating hash map of the existing messages.
             */
            let existingMessageHash = {};
            for (let message of messages) {
              existingMessageHash[message.id] = true;
            }
        
            /**
             * Push only those messages which do not
             * exist in the hashMap
             */
            for (let message of newMessages) {
              if (!existingMessageHash[message.id]) {
                messages.push(message);
              }
            }
        
            writeMessagesArray();
          });
        }
        
        async function loadHistoricalMessages() {
          messages = [];
          const querySnapshot = await _MyFirebase._firestore.getDocs(_MyFirebase._firestore.collection(_MyFirebase.db, "messages"));
          querySnapshot.forEach((doc) => {
            messages.push({
              id: doc.id,
              ...doc.data(),
            });
          });
          console.log(messages);
          return messages;
        }
        
        function writeMessagesArray() {
          const html = [];
          for (let message of messages) {
            html.push(messageTemplate(message.message, message.user, message.created));
          }
          document.getElementById("messageList").innerHTML = html.join("");
        }
        
        function messageTemplate(message, username, timestamp) {
          return `<li>
            <div class="flex space-x-2 pl-2 pt-2">
              <div class="flex flex-col">
                <div class="flex items-baseline space-x-2">
                  <div class="text-sm font-bold">${username}</div>
                  <div class="text-sm text-gray-400">${
                    new Date(timestamp.seconds * 1000).toLocaleDateString() +
                    " " +
                    new Date(timestamp.seconds * 1000).toLocaleTimeString()
                  }</div>
                </div>
                <div class="text-sm text-gray-500">${message}</div>
              </div>
            </div>
          </li>`;
        }
        
    </script>
          
  </body>
</html>
