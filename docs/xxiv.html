<!DOCTYPE html>

<!--
xxiv
-->

<!--
https://jbachnp.github.io/AhNull/xxiv.html
-->

<html lang="en" class="h-100">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>My Word List</title>
	<link rel="icon" href="favicon.ico">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!--ðŸŸ¢ style-->
	<style>
        .hide2 {
            display: none !important; 
        }
        .selectedCell{
            background-color:yellowgreen !important;
            font:bold;
        }
        .mixedCell{
            background-color:green !important;
        }

		.odd {
			background-color:beige; /* Light gray for odd items */
		}
		
		.even {
			background-color:burlywood; /* White for even items */
		}		
	</style>

    <!--ðŸŸ¢ templates -->
    <div id="tpls">
        <script type="text/template" name="tplPassage">
        </script>
    </div>

</head>

<body class="d-flex flex-column h-100" style="padding-top: 3rem">
    <!--ðŸŸ¢ main UI-->
	<header>
		<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark py-0">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">My Word List</a>
	
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				
				<div class="collapse navbar-collapse" id="navbarCollapse">
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li class="nav-item">
							<a class="nav-link active" href="#" data-bs-toggle="modal" data-bs-target="#dlgFilter">Filter</a>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle active" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">SystemðŸ˜ˆ</a>
							<ul class="dropdown-menu" aria-labelledby="navbarDropdown">
								<li><a class="dropdown-item" href="#" id="btnReloadLocalDB">recreate database</a></li>
								<li><hr class="dropdown-divider"></li>
								<li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#dlgSave">Save</a></li>
								<li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#dlgLoad">Load</a></li>
							</ul>
						</li>
					</ul>
				</div>
	
			</div>
		</nav>
	</header>

	<!--main class="flex-shrink-0"-->
	<main class="flex-shrink-0">
	<div class="container">
		<ul class="list-group" id="divWordList"></ul>
	</div>
	</main>

	<footer class="footer fixed-bottom mt-auto py-1 bg-light">
		<div class="container">
			<span>Hail FT.</span>
		</div>
	</footer>

	<!-- Filter dialogue -->
	<div class="modal fade" id="dlgFilter" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="dlgFilterLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="dlgFilterLabel">Filter Words</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<table class="table table-bordered" id="tblWordGroup">
						<thead>
							<tr>
								<th scope="col">#</th>
								<th scope="col" data-option='A1'>A1</th>
								<th scope="col" data-option='A2'>A2</th>
								<th scope="col" data-option='B1'>B1</th>
								<th scope="col" data-option='B2'>B2</th>
								<th scope="col" data-option='C1'>C1</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<th scope="row" data-option='n.'>n.</th>
								<td>-</td>
								<td>-</td>
								<td>-</td>
								<td>-</td>
								<td>-</td>
							</tr>
							<tr>
								<th scope="row" data-option='v.'>v.</th>
								<td>-</td>
								<td>-</td>
								<td>-</td>
								<td>-</td>
								<td>-</td>
							</tr>
							<tr>
								<th scope="row" data-option='adj.'>adj.</th>
								<td>-</td>
								<td>-</td>
								<td>-</td>
								<td>-</td>
								<td>-</td>
							</tr>
							<tr>
								<th scope="row" data-option='misc.'>misc.</th>
								<td>-</td>
								<td>-</td>
								<td>-</td>
								<td>-</td>
								<td>-</td>
							</tr>
						</tbody>
					</table>

					<select class="form-select" id="optProgress">
						<option value="Z">(all)</option>
						<option value="p">âšª</option>
						<option value="q">ðŸ”´</option>
						<option value="r">ðŸ”µ</option>
					</select>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="btnFilter">Apply</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Save dialogue -->
	<div class="modal fade" id="dlgSave" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="dlgSaveLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="dlgSaveLabel">Save</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="text" class="form-control" name="txtFilename" placeholder="save as">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="btnSave">Save</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Load dialogue -->
	<div class="modal fade" id="dlgLoad" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="dlgLoadLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="dlgLoadLabel">Load</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="text" class="form-control" name="txtFilename" placeholder="load from">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="btnLoad">Load</button>
				</div>
			</div>
		</div>
	</div>



	<!--ðŸŸ¢ app-->
    <script>
	window.addEventListener("load",(async function(){
		const db = new Dexie("MyDatabase");
		db.version(1).stores({
			wordlist: '[w+s], p, [s+l]' // Composite primary key
		});
		if(await db.wordlist.count()==0){
			await reloadLocalDB();
		}

        const storedUsername = localStorage.getItem('username'); // Retrieve the username
        if (storedUsername) {
            document.querySelector('#dlgSave input[name="txtFilename"]').value = storedUsername;
            document.querySelector('#dlgLoad input[name="txtFilename"]').value = storedUsername;
        }


		let wordlistfilter = createWordListFilter(document.querySelector('#tblWordGroup'), document.querySelector('#optProgress'));           
		document.querySelector('#btnFilter').addEventListener('click', async e=>{
			await renderWordlist(wordlistfilter.getValue());
		});

		await renderWordlist(wordlistfilter.getValue());

		document.querySelector('#btnReloadLocalDB').addEventListener('click', async e=>{
			await reloadLocalDB();
			await renderWordlist(wordlistfilter.getValue());
		});

		document.querySelector('#btnSave').addEventListener('click', async e=>{
			const filename = document.querySelector('#dlgSave input[name="txtFilename"]').value;
			
			const url = `https://getpantry.cloud/apiv1/pantry/4a94a23b-48e7-40fb-a0f9-9349c7e3eafb/basket/${filename}`;
			const headers = {
				'Content-Type': 'application/json',
				'Accept': 'text/html'
			};
			const requestBody = {data: await getData()};
			const response = await myFetch('POST', url, headers, requestBody);
			//const data = await response.();
			
			alert("ðŸ‘Œ");
			localStorage.setItem('username', filename);
		});

		document.querySelector('#btnLoad').addEventListener('click', async e=>{
			const filename = document.querySelector('#dlgLoad input[name="txtFilename"]').value;
			
			const url = `https://getpantry.cloud/apiv1/pantry/4a94a23b-48e7-40fb-a0f9-9349c7e3eafb/basket/${filename}`;
			const headers = {
				'Accept': 'application/json'
			};
			const response = await myFetch('GET', url, headers, null);
			const wordlist = (await response.json()).data;

			await db.wordlist.clear();
			await db.wordlist.bulkAdd(wordlist);

			await renderWordlist(wordlistfilter.getValue());

			alert("ðŸ‘Œ");
			localStorage.setItem('username', filename);

		});

		//--------------------------------------------------------------
		function createWordListFilter(ePOSLvlTable, eSelProgress){
			init();
			render();

			return {
				getValue: getValue
			};

			function init(){
				ePOSLvlTable.querySelectorAll('td').forEach(cell => {
					cell.dataset.selected = 'false';
					cell.addEventListener('click', function() {
						this.dataset.selected = !(this.dataset.selected === 'true');
						render();
					});
				});

				ePOSLvlTable.querySelectorAll('th').forEach(cell => {
					cell.dataset.selected = 'false';
				});

				ePOSLvlTable.rows[3].cells[4].dataset.selected = true;

				Array.from(ePOSLvlTable.rows[0].cells).slice(1).forEach(cell=>{
					cell.addEventListener('click', function() {
					let selected = this.dataset.selected === 'true'; // Convert string to boolean

					this.dataset.selected = !selected; // Update data-selected attribute

					let col = Array.from(this.parentNode.cells).indexOf(this);

					Array.from(ePOSLvlTable.rows).slice(1).forEach(eRow => {
						eRow.cells[col].dataset.selected = !selected; // Update data-selected attribute
					});

					// Call the render function
					render();
					});
				});

				Array.from(ePOSLvlTable.rows).slice(1).forEach(eRow=>{
					eRow.cells[0].addEventListener('click', function() {
						let selected = (this.dataset.selected === 'true');
						this.dataset.selected = !selected;
						Array.from(eRow.cells).slice(1).forEach(eTD=>eTD.dataset.selected = !selected);
						render();
					});
				});

				ePOSLvlTable.rows[0].cells[0].addEventListener('click', function() {
					let selected = (this.dataset.selected === 'true');
					this.dataset.selected = !selected;
					Array.from(ePOSLvlTable.rows).slice(1).forEach(eRow=>Array.from(eRow.cells).slice(1).forEach(eTD=>eTD.dataset.selected = !selected));
					render();
				});
			}

			function render(){
				//render cells
				ePOSLvlTable.querySelectorAll('td').forEach(cell => {
					cell.classList.remove('selectedCell');
					let selected = (cell.dataset.selected === 'true');
					if(selected){
						cell.classList.add('selectedCell');
					}
				});

				//render row header
				Array.from(ePOSLvlTable.rows).slice(1).forEach(eRow=>{
					renderSummaryCell(eRow.cells[0], Array.from(eRow.cells).slice(1).map(eTD=>(eTD.dataset.selected === 'true')));
				});

				//render column header
				Array.from(ePOSLvlTable.rows[0].cells).slice(1).forEach((eCell, i)=>{
					renderSummaryCell(eCell, Array.from(ePOSLvlTable.rows).slice(1).map(eRow=>(eRow.cells[i + 1].dataset.selected === 'true')));
				});

				//render the upper left corner
				renderSummaryCell(ePOSLvlTable.rows[0].cells[0], 
					Array.from(ePOSLvlTable.rows).slice(1).reduce((ret, row)=>{ ret.push(...Array.from(row.cells).slice(1).map(eTD=>(eTD.dataset.selected === 'true'))); return ret}, []));

				return;
				function renderSummaryCell(eCell, selected){
					eCell.classList.remove('selectedCell', 'mixedCell');
					if(selected.every(e=>e)){
						eCell.classList.add('selectedCell');
					}else if(selected.some(e=>e)){
						eCell.classList.add('mixedCell');
					}
				}
			}
		
			function getValue(){
				let ret = {
					pos_lvl: [],
					progress: eSelProgress.value
				};

				ePOSLvlTable.querySelectorAll('td').forEach(cell => {
					if(!(cell.dataset.selected === 'true')){
						return;
					}
					var rowIndex = cell.parentNode.rowIndex;
					var colIndex = cell.cellIndex;

					ret.pos_lvl.push({
						pos: ePOSLvlTable.rows[rowIndex].cells[0].dataset.option,
						lvl: ePOSLvlTable.rows[0].cells[colIndex].dataset.option
					});

				});
				return ret;
			}
		}

		async function renderWordlist(filterValue){
			document.getElementById('divWordList').innerHTML = '';

			let wordlist = await getData();
			let divWordList = document.getElementById('divWordList');

			wordlist
				.filter(w=>{
					return filterValue.pos_lvl.some(e=>(
						(e.pos != 'misc.' && e.pos == w.s) || (e.pos == 'misc.' && ['n.', 'v.', 'adj.'].every(t=> w.s != t) )) 
						&& e.lvl == w.l
					);
				})
				.filter(w=>((filterValue.progress === 'Z') || (filterValue.progress === (w.p||'p'))  ))
				.forEach((oWord, index)=>{
					divWordList.insertAdjacentHTML('beforeend', tplWord(oWord, index));
					let eLI = divWordList.lastElementChild;
					eLI.querySelector("a").addEventListener('click', ()=>{
						window.open(`https://dictionary.cambridge.org/dictionary/english-chinese-traditional/${oWord.w}`, "_Cambridge");
						window.open(`https://www.oxfordlearnersdictionaries.com/definition/english/${oWord.w}`, "_Oxford");
						window.focus();
					});

				});

				document.querySelectorAll('#divWordList li').forEach(async(eLI, i)=>{
					const wordX = await db.wordlist.get({ w: eLI.dataset.w, s: eLI.dataset.s });
					let v = wordX ? wordX.p : "p";
					eLI.querySelector(`button[name='${v}']`)?.classList.add("active");

					eLI.querySelectorAll("button").forEach(eBtn=>{
						eBtn.addEventListener('click', async function(){
							let v = this.getAttribute("name");
							this.parentNode.querySelectorAll("button").forEach(e=>e.classList.remove("active"));
							this.classList.add("active");
							await db.wordlist.put({ w: eLI.dataset.w, s: eLI.dataset.s, l:eLI.dataset.level, p: v });
						});
					});
				});

			return;

			function tplWord(oWord, index){
				return `
				<li class="list-group-item d-flex justify-content-between align-items-center p-1 word-entry ${index % 2 === 0 ? 'even' : 'odd'} " data-w="${oWord.w}" data-s="${oWord.s}" data-level="${oWord.l}">
					<span class="flex-grow-0"><a>${oWord.w}</a> (<i>${oWord.s}</i>) <span class="badge bg-secondary">${oWord.l}</span></span>
					<div class="btn-group btn-group-sm" role="group">
						<button type="button" class="btn" name="p">âšª</button>
						<button type="button" class="btn" name="q">ðŸ”´</button>
						<button type="button" class="btn" name="r">ðŸ”µ</button>
					</div>
				</li>
				`;
			}

		}

		//--------------------------------------------------------------
		async function getData(){
			return await db.wordlist.toArray();
		}

		async function reloadLocalDB(){
			let wordlist = await getWordListFromWeb();
			await db.wordlist.clear();
			await db.wordlist.bulkAdd(wordlist);
		}
	
		async function getWordListFromWeb(){
			const url = 'https://jbachnp.github.io/AhNull/xxiv.wordlist.json';
			const headers = new Headers({
				'Content-Type': 'application/json'
			});

			const response = await myFetch('GET', url, headers, null);
			const data = await response.json();

			return data;
		}



		//--------------------------------------------------------------

		async function myFetch(method, url, headers, oReqBody){
			try{
				document.body.style.cursor = 'wait';
				let postData = JSON.stringify(oReqBody);

				const requestOptions = {
					method: method,
					headers: {
					}
				};

				if(method === 'POST'){
					requestOptions.headers['Content-Length'] = postData.length;
					requestOptions.body = postData;
				}

				Object.entries(headers).forEach(([key, value]) => {
					requestOptions.headers[key] = value;
				});

				const response = await fetch(url, requestOptions);

				return response;
			}catch(e){
					console.log(e);
			}finally {
				document.body.style.cursor = '';
			}
		}
	
	}));
	</script>

	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
</body>
</html>
