<!DOCTYPE html>

<!--
    https://jbachnp.github.io/AhNull/yes.html
-->

<html>
<head>
    <title>My AES Decryptor</title>
    <link rel="icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!--<link rel="manifest" href="manifest.json">-->
    <!--includes-->
    <script src="SharedTechnology/ExternalDependency/JsLibrary/Underscore/underscore-min.js"></script>
    <script src="SharedTechnology/ExternalDependency/JsLibrary/JQuery/jquery-3.0.0.min.js"></script>

    <script src="SharedTechnology/ExternalDependency/JsLibrary/popper/popper.min.js"></script>
    <link rel="stylesheet" href="SharedTechnology/ExternalDependency/JsLibrary/bootstrap/css/bootstrap.min.css">
    <script src="SharedTechnology/ExternalDependency/JsLibrary/bootstrap/js/bootstrap.min.js"></script>
</head>

<body>
    <!--style-->
    <style type="text/css">
        /*fix for bs*/
        body {
            padding-top: 3.2rem; /*match the navbar height*/
        }

        /*opinionated twist of BS default*/
        .row {
            margin: 0.1rem 0rem 0.1rem 0rem;
        }

        div[class^="col-"] {
            padding-left: 0.1rem;
            padding-right: 0.1rem;
        }

        .navbar {
            padding: 0.1rem;
        }

        a.navbar-brand {
            font-family: 'Comic Sans MS';
            font-size: 1.6rem;
            padding: 0.1rem;
        }

        a.nav-link {
            font-size: 1.5rem;
            padding: 0.1rem;
            text-align: right;
        }

        .card{
            padding:0.1rem;
            margin:0.1rem;
        }

        .card-body{
            padding:0.1rem;
        }

        /*my app*/
        main.container { /*main client area*/
            padding-left: 0.2rem;
            padding-right: 0.2rem;
        }

        main > div { /*pages*/
            padding: 0.2rem 0.1rem 0.1rem 0.1rem;
            border-style: solid;
            border-width: 1px;
            border-color: lightgray;
        }

            main > div > div.container { /*container inside page*/
                padding-left: 0.2rem;
                padding-right: 0.2rem;
            }

            main > div[name='pgHome'] textarea[name='txtMsg'] {
                margin: 0.2rem;
                padding: 0.5rem;
                line-height: 150%;
                font-size: x-large;
            }

        .blur {
            -webkit-filter: blur(5px);
            filter: blur(5px);
        }

        textarea:focus {
            background-color: Khaki !important;
        }
    </style>

    <!--UI-->
    <nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary">
        <a class="navbar-brand" href="javascript:void(0);"><img src="favicon.ico" style="height:1.4rem;" />My AES Decryptor</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" data-anull_pagescontainer="main">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active"><a class="nav-link" href="javascript:void(0);" data-anull_page="div[name='pgHome']">üè°</a></li>
                <li role="separator" class="dropdown-divider"></li>
                <li class="nav-item active"><a class="nav-link" href="javascript:void(0);" data-anull_page="div[name='pgAbout']">‚ùó</a></li>
            </ul>
        </div>
    </nav>

    <main role="main" class="container">

        <div name="pgHome">
            <input type="text" name="uiCiphertext" class="form-control" placeholder="Ciphertext" />
            <input type="text" name="uiIV" class="form-control" placeholder="IV" />
            <input type="text" name="uiKey" class="form-control" placeholder="Key" />

            <button name="btnGo" class="btn form-control">Go</button>
            <textarea name="txtDecrypted" class="form-control" rows="5" readonly>
            </textarea>
        </div>

        <div name="pgAbout">
            <h3>About</h3>
            <p>
                I have two monkeys. They are Monkey One and Monkey Two. I make this small gadget for their self study.<br />
            </p>
            <p>
                BTW, do you notice the relation between <span style="font-style:italic">Fundamental Theorem of Algebra (FTA)</span>
                and <span style="font-style:italic">Holy Roman Empire (HRE)</span>...
            </p>
            <p>
                <span style="font-style:italic">The Answer: </span> while HRE is "neither holy, nor Roman, nor an empire" (by Voltaire),
                FTA is "neither fundamental, nor a theorem, nor properly within the scope of algebra".
            </p>
        </div>

    </main>

    <!--templates -->
    <div id="tpls">
    </div>

    <!--config-->
    <script type="text/javascript">
        var MyApp = MyApp || {}; //Root object of the app

        (function (app, undefined) {
            _.templateSettings = {
                evaluate: /\{\{([\s\S]+?)\}\}/g,            // {{ console.log("blah") }}
                interpolate: /\{\{\=([\s\S]+?)\}\}/g,  // {{= title }}
                escape: /\{\{\-([\s\S]+?)\}\}/g,         // {{- title }}
                variable: "o"
            }

        })(MyApp);

        MyApp.BsExtra = (function bs_plus() {
            var cnst_BsExtra_OpeningPage = "_BsExtra_OpeningPage";
            var cnst_BsExtra_fPageOnOpen = "_BsExtra_fPageOnOpen";
            var cnst_BsExtra_fPageOnClose = "_BsExtra_fPageOnClose";

            var _ret = {};

            function openPage(ePageRepo, pageSelector) {
                var joPageRepo = $(ePageRepo);

                var joCurrentPage = joPageRepo.children("div." + cnst_BsExtra_OpeningPage);
                if (joCurrentPage.length > 0) {
                    joCurrentPage.addClass("d-none").removeClass(cnst_BsExtra_OpeningPage);
                    if (joCurrentPage[0][cnst_BsExtra_fPageOnClose]) {
                        joCurrentPage[0][cnst_BsExtra_fPageOnClose]();
                    }
                }

                var joNextPage = joPageRepo.children(pageSelector);
                if (joNextPage.length > 0) {
                    joNextPage.removeClass("d-none").addClass(cnst_BsExtra_OpeningPage);
                    if (joNextPage[0][cnst_BsExtra_fPageOnOpen]) {
                        joNextPage[0][cnst_BsExtra_fPageOnOpen]();
                    }
                }
            }

            $("*[data-anull_pagescontainer]").each(function (i, eMnu) {
                var ePageRepo = document.querySelector(eMnu.dataset["anull_pagescontainer"]);

                $(eMnu.dataset["target"]).find("a[data-anull_page]").each(function (j, eMnuItem) {
                    var ps = eMnuItem.dataset["anull_page"];
                    $(ePageRepo).children(ps).addClass("d-none").removeClass(cnst_BsExtra_OpeningPage);
                    $(eMnuItem).click(function () {
                        $(eMnu).click();
                        openPage(ePageRepo, ps);
                    })
                });
            });

            function pageOnOpen(ePageRepo, pageSelector, fPageOnOpen) {
                var joPageRepo = $(ePageRepo);
                joPageRepo.children(pageSelector).each(function (i, ePage) {
                    ePage[cnst_BsExtra_fPageOnOpen] = fPageOnOpen;
                });
            }

            function pageOnClose(ePageRepo, pageSelector, fPageOnClose) {
                var joPageRepo = $(ePageRepo);
                joPageRepo.children(pageSelector).each(function (i, ePage) {
                    ePage[cnst_BsExtra_fPageOnClose] = fPageOnClose;
                });
            }

            _ret.openPage = openPage;
            _ret.pageOnOpen = pageOnOpen;
            _ret.pageOnClose = pageOnClose;

            return _ret;
        })()

    </script>

    <!--app logic uiVolume-->
    <script>
        (async function (app, undefined) {
            var _AppLog = function (s) { console.log(s); };
            var tplFuncs = (function () {
                var ret = {};
                $('#tpls > script[type="text/template"]').each(function (i, o) {
                    ret[$(o).attr("name")] = _.template(o.innerText);
                });
                return ret;
            })();

            var _BsExtra = app.BsExtra;
            const $2 = (pg, ctrl)=>$(`main > div[name='${pg}'] *[name='${ctrl}']`);

            //----------------------------------------------------------------------------
            (function initGui() {
                _BsExtra.openPage(document.querySelector("main"), "main>div[name='pgHome']");
            })()
            _AppLog("init completed");
            _AppLog("welcome");

            $2("pgHome", "uiCiphertext").val("8xRKHF+hMyRP8StPsKctEh8LNEuQPFjN9N5wNgq/tuQmRZCERv8hn3Clp7MKFf7FhTv2HCUOTXhdERaiFWF8yQ2bL4GuYIXzdx19VEM8min5WAOQEfLghhC2RPlaZiIXv05BnIXCNUKa6SRKwIJCrFRV2xvNNg2yJp0TF70CJhW4W574YOxFy5wAF5d81UJNuPwr56Tr6fdUt9NvTbL223E1bee4pAlB8+PZYpNcQS0=");
            $2("pgHome", "uiIV").val("0123456789012345");
            $2("pgHome", "uiKey").val("01234567890123456789012345678901");

            //Page: Home----------------------------------------------------------------------------
            $2("pgHome", "btnGo").click(async function () {
                //${} ${$2("pgHome", "uiIV").val()} ${$2("pgHome", "uiKey").val()} `);
                const ct = $2("pgHome", "uiCiphertext").val();
                const iv = $2("pgHome", "uiIV").val();
                const ky = $2("pgHome", "uiKey").val();

                // from https://stackoverflow.com/a/11562550/9014097
                // function buf2Base64(buffer) {
                //     return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
                // }

                // var inputString = "The quick brown fox jumps over the lazy dog";
                // inputBytes = new TextEncoder().encode(inputString);
                // hashBytes = await crypto.subtle.digest("SHA-256", inputBytes);
                // console.log(JSON.stringify({hash: buf2Base64(hashBytes)})); // {"hash":"16j7swfXgJRpypq8sAguT41WUeRtPNt2LQLQvzfJ5ZI="}

                let _k = await crypto.subtle.importKey("raw", (new TextEncoder()).encode(ky), {name: "AES-CBC"}, false, ["encrypt", "decrypt"]);

                let argbuf = Uint8Array.from(atob(ct), c => c.charCodeAt(0));

                let decrypted = await window.crypto.subtle.decrypt(
                    {
                        name: "AES-CBC",
                        iv: (new TextEncoder()).encode(iv)
                    },
                    _k,
                    argbuf
                );                

                console.log(decrypted);
            });

            //Page: ABout----------------------------------------------------------------------------

        })(MyApp);


    </script>

</body>
</html>
